\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{graphpaper}
    [2021/03/12 v1.0.0 Graph paper backgrounds]
%% TODO: Fix metadata above

\RequirePackage{xkeyval}
\RequirePackage{xcolor}
\RequirePackage{tikz}
\usetikzlibrary{patterns.meta,calc}
\RequirePackage{tikzpagenodes}
\RequirePackage{everypage}
\RequirePackage{pagecolor}


%% TODO: Process options and pass to geometry
\RequirePackage{geometry}


%%-----------------------------------------------------------------------
%% Some nice colors.
%%-----------------------------------------------------------------------
\definecolor{plum}{rgb}{0.36078, 0.20784, 0.4}
\definecolor{chameleon}{rgb}{0.30588, 0.60392, 0.023529}
\definecolor{cornflower}{rgb}{0.12549, 0.29020, 0.52941}
\definecolor{scarlet}{rgb}{0.8, 0, 0}
\definecolor{brick}{rgb}{0.64314, 0, 0}
\definecolor{sunrise}{rgb}{0.80784, 0.36078, 0}
\definecolor{rosiebg}{RGB}{250,247,232}
\definecolor{rosiegrid}{RGB}{186,137,113}

%%-----------------------------------------------------------------------
%% The color to use for the null directions when drawing lightcones.
%%-----------------------------------------------------------------------
\colorlet{lightlines}{scarlet!30}

%%-----------------------------------------------------------------------
%% Pre-defined Color schemes
%%-----------------------------------------------------------------------
%% Here are some pre-defined color schemes for the paper background
%% and the major and minor grid lines.  These are switched by using
%% the option colorset=<name>.  The allowed values for colorset are in
%% the list below.
%%
%% TODO Move this comment to an example file
%% A number of rgb colors are defined above. You can make either one
%% darker by changing the number after the "!". For instance,
%% cornflower!75 is darker than cornflower!25.
\define@choicekey*{GP}{colorset}[\val\nr]%
  % Allowed values for colorset:
  {std,precocious,brickred,engineer,plumpad}[std]{%
  \ifcase\nr\relax
    % std
    \colorlet{minorcolor}{cornflower!30}
    \colorlet{majorcolor}{cornflower!50}
    \colorlet{bgcolor}{white}
  \or
    % precocious
    \colorlet{minorcolor}{rosiegrid!50}
    \colorlet{majorcolor}{rosiegrid}
    \colorlet{bgcolor}{rosiebg}
  \or
    % brickred
    \colorlet{minorcolor}{brick!35}
    \colorlet{majorcolor}{brick!60}
    \colorlet{bgcolor}{scarlet!8}
  \or
    % engineer
    \colorlet{minorcolor}{chameleon!50}
    \colorlet{majorcolor}{chameleon!80}
    \colorlet{bgcolor}{chameleon!10}
  \or
    % plumpad
    \colorlet{minorcolor}{cornflower!40}
    \colorlet{majorcolor}{cornflower!70}
    \colorlet{bgcolor}{plum!10}
  \fi
}

% Start with std as a default
\setkeys{GP}{colorset=std}

%%-----------------------------------------------------------------------
%% This section sets up a routine for filling a shape with
%% hexagons. Uses code from:
%% http://tex.stackexchange.com/questions/6019/drawing-hexagons/6128#6128
%%-----------------------------------------------------------------------

%% Hexagon size
%% QUESTION: Should we just have 'majorsize' and 'minorsize' and use
%% that value here?
\define@key{GP}{hexagonsize}{\def\hexagonsize{#1}}

%% Start with big hexagons as a default
\setkeys{GP}{hexagonsize=0.1666in}
%% TODO Move this to an example file
%% Small hexagons
%\setkeys{GP}{hexagonsize=0.0833in}

%% TODO This pattern actually has to be declared *after* the options
%% are parsed, otherwise it won't get its size from the options
\pgfdeclarepatternformonly
  {hexagons}% name
  {\pgfpointorigin}% lower left
  {\pgfpoint{3*\hexagonsize}{0.866025*2*\hexagonsize}}
  {\pgfpoint{3*\hexagonsize}{0.866025*2*\hexagonsize}}
  {
    \pgfsetlinewidth{0.6pt}
    \pgftransformshift{\pgfpoint{0mm}{0.866025*\hexagonsize}}
    \pgfpathmoveto{\pgfpoint{0mm}{0mm}}
    \pgfpathlineto{\pgfpoint{0.5*\hexagonsize}{0mm}}
    \pgfpathlineto{\pgfpoint{\hexagonsize}{-0.866025*\hexagonsize}}
    \pgfpathlineto{\pgfpoint{2*\hexagonsize}{-0.866025*\hexagonsize}}
    \pgfpathlineto{\pgfpoint{2.5*\hexagonsize}{0mm}}
    \pgfpathlineto{\pgfpoint{3*\hexagonsize}{0mm}}
    \pgfpathmoveto{\pgfpoint{0.5*\hexagonsize}{0mm}}
    \pgfpathlineto{\pgfpoint{\hexagonsize}{0.866025*\hexagonsize}}
    \pgfpathlineto{\pgfpoint{2*\hexagonsize}{0.866025*\hexagonsize}}
    \pgfpathlineto{\pgfpoint{2.5*\hexagonsize}{0mm}}
    \pgfusepath{stroke}
  }

%%-----------------------------------------------------------------------
%% This section sets up a routine for filling a shape with
%% triangles.
%%-----------------------------------------------------------------------

%% Triangle size
%% QUESTION: Should we just have 'majorsize' and 'minorsize' and use
%% that value here?
\define@key{GP}{trianglesize}{\def\trianglesize{#1}}

%% Start with bigger triangles as a default
\setkeys{GP}{trianglesize=2*0.125in}
%% TODO Move this to an example file
%% Smaller triangles
%\setkeys{GP}{trianglesize=0.125in}

%% TODO This pattern actually has to be declared *after* the options
%% are parsed, otherwise it won't get its size from the options
\pgfdeclarepatternformonly
  % Name of the pattern
  {triangles}
  % Set the lower left corner of the pattern
  {\pgfpointorigin}
  % Set the upper right corner of the pattern
  {\pgfpoint{\trianglesize}{2*0.8660254*\trianglesize}}
  % Declare the size of the pattern blocks
  {\pgfpoint{\trianglesize}{2*0.8660254*\trianglesize}}
  % Draw the pattern
  {
    \pgfsetlinewidth{0.6pt}
  \pgfpathmoveto{\pgfpoint{0mm}{0mm}}
  \pgfpathlineto{\pgfpoint{\trianglesize}{2*0.8660254*\trianglesize}}
  \pgfpathlineto{\pgfpoint{0mm}{2*0.8660254*\trianglesize}}
    \pgfpathmoveto{\pgfpoint{0mm}{0.8660254*\trianglesize}}
  \pgfpathlineto{\pgfpoint{\trianglesize}{0.8660254*\trianglesize}}
    \pgfpathmoveto{\pgfpoint{0mm}{2*0.8660254*\trianglesize}}
  \pgfpathlineto{\pgfpoint{\trianglesize}{0mm}}
  \pgfpathlineto{\pgfpoint{0mm}{0mm}}
    \pgfusepath{stroke}
  }

\pgfdeclarepatternformonly
  % Name of the pattern
  {isometric}
  % Set the lower left corner of the pattern
  {\pgfpointorigin}
  % Set the upper right corner of the pattern
  {\pgfpoint{2*0.8660254*\trianglesize}{\trianglesize}}
  % Declare the size of the pattern blocks
  {\pgfpoint{2*0.8660254*\trianglesize}{\trianglesize}}
  % Draw the pattern
  {
    \pgfsetlinewidth{0.6pt}
  \pgfpathmoveto{\pgfpoint{0mm}{0mm}}
  \pgfpathlineto{\pgfpoint{2*0.8660254*\trianglesize}{\trianglesize}}
  \pgfpathlineto{\pgfpoint{2*0.8660254*\trianglesize}{0mm}}
  \pgfpathlineto{\pgfpoint{0mm}{\trianglesize}}
  \pgfpathlineto{\pgfpoint{0mm}{0mm}}
    \pgfpathmoveto{\pgfpoint{0.8660254*\trianglesize}{0mm}}
    \pgfpathlineto{\pgfpoint{0.8660254*\trianglesize}{\trianglesize}}
    \pgfusepath{stroke}
  }

%%-----------------------------------------------------------------------
%% This section sets up a routine for filling the squares in a
%% grid with null lines.
%%-----------------------------------------------------------------------
%% TODO Make an option
\def\squaresize{0.25in}
\pgfkeys{
  /pgf/pattern keys/myshift/.store in=\myshift,
  /pgf/pattern keys/myshift/.initial={(0,0)},
}
\tikzdeclarepattern{
  name=lightcones,
  type=uncolored,
  parameters={\myshift},
  bounding box={(0,0) and (\squaresize,\squaresize)},
  tile size={(\squaresize, \squaresize)},
  tile transformation={
    shift=\myshift,
  },
  defaults={
    myshift/.store in=\myshift,myshift={(0,0)},
  },
  code={
    % TODO Make the dashing an option
    \tikzset{lightlines/.style={line width=0.4pt,dash=on 0.05cm off 0.05cm phase 0.025cm}}
    \draw [lightlines] (0,0) -- (\squaresize,\squaresize);
    \draw [lightlines] (0,\squaresize) -- (\squaresize,0);
  },
}
% \pgfdeclarepatternformonly
%   {lightcones}% name
%   {\pgfpointorigin}% lower left
%   {\pgfpoint{\squaresize}{\squaresize}}%  upper right
%   {\pgfpoint{\squaresize}{\squaresize}}%  tile size
%   {% shape description
%     \pgfsetlinewidth{0.4pt}
%     %% TODO Make an option
%     %Comment out this line for solid lines on light cones, instead of dashes.
%     \pgfsetdash{{0.05cm}{0.05cm}}{0.025cm}
%     \pgfpathmoveto{\pgfpoint{0in}{0in}}
%     \pgfpathlineto{\pgfpoint{\squaresize}{\squaresize}}
%     \pgfpathmoveto{\pgfpoint{0in}{\squaresize}}
%     \pgfpathlineto{\pgfpoint{\squaresize}{0in}}
%     \pgfusepath{stroke}
%   }

%%-----------------------------------------------------------------------
%% This section sets up a routine for filling a region with dots
%% Slightly modified version of code added by Leo
%% Stein (@duetosymmetry on Twitter).
%%-----------------------------------------------------------------------
%% Dot grid size
%% QUESTION: Should we just have 'majorsize' and 'minorsize' and use
%% that value here?
\define@key{GP}{dotgridsize}{\def\dotgridsquaresize{#1}}

%% Start with small squares as a default
\setkeys{GP}{dotgridsize=0.1in}
%% TODO Move this to an example file
%% Big squares
%\setkeys{GP}{dotgridsize=0.2in}

%% Dot size
\define@key{GP}{dotsize}{\def\dotsize{#1}}

\setkeys{GP}{dotsize=.7pt}

\pgfdeclarepatternformonly
  {dotgrid}% name
  {\pgfpoint{-0.5*\dotgridsquaresize}{-0.5*\dotgridsquaresize}}% lower left
  {\pgfpoint{0.5*\dotgridsquaresize}{0.5*\dotgridsquaresize}}%  upper right
  {\pgfpoint{\dotgridsquaresize}{\dotgridsquaresize}}%  tile size
  {% shape description
    \pgfpathcircle{\pgfqpoint{0pt}{0pt}}{\dotsize}
    \pgfusepath{fill}
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Begin pattern execution infrastructure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% This inner code will be set by the choicekey pattern=...
\newcommand{\innerpatterncode}{}
% This is the "outer" code to hook into every page
\newcommand{\patterncode}{% No blank lines in this code!
\begin{tikzpicture}[remember picture, overlay]
%
%% Change "thin" to "very thin" if the lines are too thick.
\tikzset{
  minorgrid/.style={minorcolor, thin},
  majorgrid/.style={majorcolor, thin},
}
\ifKV@GP@fullpage%
\coordinate (a) at (current page.south west);
\coordinate (b) at (current page.north east);
\else%
\coordinate (a) at (current page text area.south west);
\coordinate (b) at (current page text area.north east);
\fi
%
\innerpatterncode%
%
\end{tikzpicture}
}
%% Set the background color.
\AtBeginDocument{\pagecolor{bgcolor}}
% Actually hook it in!
\AddEverypageHook{%
\patterncode%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Begin pattern definition code
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\define@choicekey*{GP}{pattern}[\val\nr]%
  % Allowed values for pattern:
  {std,stdeight,majmin,dot,hex,tri,iso,lightcone,ruled,doubleruled}[std]{%
  \ifcase\nr\relax
    % std
%%-----------------------------------------------------------------------
%% Quadrille, ten squares per inch.
%%-----------------------------------------------------------------------
    \renewcommand{\innerpatterncode}{%
%% Draw a grid with 10 squares per inch.
\draw[style=minorgrid, shift={(a)}] (0,0) grid [step=0.1in] (b);
%
%% Draw a frame around the grid.
\draw[style=majorgrid] (a) rectangle (b);
    }
  \or
    % stdeight
%%-----------------------------------------------------------------------
%% Quadrille, eight squares per inch.
%%-----------------------------------------------------------------------
    \renewcommand{\innerpatterncode}{%
%% Draw a grid with 10 squares per inch.
\draw[style=minorgrid, shift={(a)}] (0,0) grid [step=0.125in] (b);
%
%% Draw a frame around the grid.
\draw[style=majorgrid] (a) rectangle (b);
    }
  \or
    % majmin
%%-----------------------------------------------------------------------
%% Graph paper, eight squares per inch with a major grid
%% every half-inch.
%%-----------------------------------------------------------------------
    \renewcommand{\innerpatterncode}{%
% Draw a grid with 10 squares per inch.
\draw[style=minorgrid, shift={(a)}] (0,0) grid [step=0.125in] (b);
%
\draw[style=majorgrid, shift={(a)}] (0,0) grid [step=0.5in]   (b);
%
% Draw a frame around the grid.
\draw[style=majorgrid] (a) rectangle (b);
    }
  \or
    % dot
%%-----------------------------------------------------------------------
%% Dot grid
%% Slightly modified version of code added by Leo
%% Stein (@duetosymmetry).
%%-----------------------------------------------------------------------
    \renewcommand{\innerpatterncode}{%
    \fill [pattern=dotgrid,pattern color=minorcolor] (a) rectangle (b);
    }
  \or
    % hex
%%-----------------------------------------------------------------------
%% Hex grid
%%-----------------------------------------------------------------------
    \renewcommand{\innerpatterncode}{%
    \fill [pattern=hexagons,pattern color=minorcolor] (a) rectangle (b);
    }
  \or
    % tri
%%-----------------------------------------------------------------------
%% Triangle grid, adjust triangle size in the preamble
%%-----------------------------------------------------------------------
    \renewcommand{\innerpatterncode}{%
      \fill [pattern=triangles,pattern color=minorcolor] (a) rectangle (b);
    }
  \or
    % iso
%%-----------------------------------------------------------------------
%% Isometric grid
%%-----------------------------------------------------------------------
    \renewcommand{\innerpatterncode}{%
      \fill [pattern=isometric, pattern color=minorcolor] (a) rectangle (b);
    }
  \or
    % lightcone
%%-----------------------------------------------------------------------
%% A grid with light cones.
%%-----------------------------------------------------------------------
    \renewcommand{\innerpatterncode}{%
%% Draw a grid with 4 squares per inch.
\draw[style=minorgrid, shift={(a)}] (0,0) coordinate grid [step=0.25in] (b);
%
%% Draw a border around the grid.
\draw[style=majorgrid, pattern={lightcones[myshift={(a)}]}, pattern color=lightlines] (a) rectangle (b);
    }
  \or
    % ruled
%%-----------------------------------------------------------------------
%% Ruled page with bold lines every 0.2in or 0.25in
%%-----------------------------------------------------------------------
    \renewcommand{\innerpatterncode}{%
%% Draw a ruled page with lines every 0.2in
\draw[style=majorgrid, shift={(a)}] (0,0) grid [ystep=0.2in, xstep=\paperwidth] (b);
    }
  \or
    % doubleruled
%%-----------------------------------------------------------------------
%% Ruled page with bold lines every 0.25in and light lines
%% every 0.125 in.
%%-----------------------------------------------------------------------
    \renewcommand{\innerpatterncode}{%
%% Draw a ruled pattern with thin lines every 0.125 in and bold lines every 0.25 in.
\draw[style=minorgrid, shift={(a)}] (0,0) grid [ystep=0.125in, xstep=\paperwidth] (b);
%
\draw[style=majorgrid, shift={(a)}] (0,0) grid [ystep=0.25in, xstep=\paperwidth] (b);
%
%% Draw a frame around the grid.
\draw[style=majorgrid] (a) rectangle (b);
    }
  \fi
}

% Do we want the background to be fullpage?
% Default: yes
\define@boolkey{GP}{fullpage}{}

\DeclareOptionX{pattern}{\setkeys{GP}{pattern=#1}}
\DeclareOptionX{colorset}{\setkeys{GP}{colorset=#1}}
% TODO: Should we just have a majsize and minsize and use for all patterns?
\DeclareOptionX{hexagonsize}{\setkeys{GP}{hexagonsize=#1}}
\DeclareOptionX{trianglesize}{\setkeys{GP}{trianglesize=#1}}
\DeclareOptionX{dotgridsize}{\setkeys{GP}{dotgridsize=#1}}
\DeclareOptionX{dotsize}{\setkeys{GP}{dotsize=#1}}
\DeclareOptionX{fullpage}{\setkeys{GP}{fullpage=true}}
\DeclareOptionX{textarea}{\setkeys{GP}{fullpage=false}}
\DeclareOptionX{majorcolor}{\colorlet{majorcolor}{#1}}
\DeclareOptionX{minorcolor}{\colorlet{minorcolor}{#1}}
\DeclareOptionX{bgcolor}{\colorlet{bgcolor}{#1}}
\DeclareOptionX*{%
  \PackageWarning{graphpaper}{Unknown option ‘\CurrentOption’}%
}
\ProcessOptionsX*

\endinput
%%
%% End of file `graphpaper.sty'.
